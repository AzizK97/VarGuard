apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: branches-appset
  namespace: argocd
spec:
  # List generator: explicitly define which branches to deploy
  generators:
  - list:
      elements:
        - branch: clean-version
          name: clean-version
          namespace: clean-version-ns
        - branch: azizTest
          name: azizTest
          namespace: aziztest-ns
        - branch: hedi1
          name: hedi1
          namespace: hedi1-ns
        - branch: test
          name: test
          namespace: test-ns
  
  template:
    metadata:
      name: '{{name}}'
      namespace: argocd
      labels:
        branch: '{{branch}}'
        managed-by: applicationset
    
    spec:
      # Project (keep as default for now)
      project: default
      
      # Git source configuration
      source:
        # Replace with your actual GitHub repo URL
        repoURL: 'https://github.com/turkimedaziz/Projet_fwk'
        
        # Dynamically set the branch from generator
        targetRevision: '{{branch}}'
        
        # Path to Kubernetes manifests in the branch
        # This path should contain the k8s/* files
        path: 'k8s'
      
      # Deployment destination
      destination:
        # Use the in-cluster API server
        server: 'https://kubernetes.default.svc'
        
        # Each branch deploys to its own namespace
        namespace: '{{namespace}}'
      
      # Sync policy: automatic deployments
      syncPolicy:
        automated:
          # Automatically sync when Git changes detected
          prune: true      # Delete resources if removed from Git
          selfHeal: true   # Auto-sync if cluster state diverges
        
        # Create namespace if it doesn't exist
        syncOptions:
        - CreateNamespace=true
